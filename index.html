<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Posture Guard - ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏ó‡πà‡∏≤‡∏ó‡∏≤‡∏á</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.13.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/movenet@1.0.0/dist/movenet.min.js"></script>
    
    <style>
        /* CSS ‡∏à‡∏≤‡∏Å UI ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢) */
        body {
            font-family: 'Sukhumvit Set', 'Kanit', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #0d1117;
            color: #e6edf3;
            padding: 16px;
            margin: 0;
        }
        .container {
            max-width: 450px;
            margin: 0 auto;
        }
        
        /* Camera Feed Area */
        .camera-feed {
            background-color: #161b22;
            position: relative;
            height: 250px; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ */
            border-radius: 12px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden; /* ‡∏ã‡πà‡∏≠‡∏ô‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ */
            border: 1px solid #30363d;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }
        video {
            width: 100%;
            height: 100%;
            object-fit: cover; /* ‡πÉ‡∏´‡πâ‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡πÄ‡∏ï‡πá‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà */
            transform: scaleX(-1); /* ‡∏Å‡∏•‡∏±‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏£‡∏∞‡∏à‡∏Å */
        }
        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: scaleX(-1); /* ‡∏Å‡∏•‡∏±‡∏ö‡∏î‡πâ‡∏≤‡∏ô Canvas ‡∏î‡πâ‡∏ß‡∏¢ */
        }

        /* Buttons and Cards (Style ‡πÄ‡∏î‡∏¥‡∏°) */
        .main-action-buttons { display: flex; gap: 12px; margin-bottom: 12px; }
        .btn { flex-grow: 1; padding: 16px 10px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; transition: background-color 0.2s, transform 0.1s; }
        .btn:active { transform: scale(0.98); }
        #startBtn { background-color: #238636; color: white; }
        #stopBtn { background-color: #da3633; color: white; }
        #calibrateBtn { background-color: #58a6ff; color: #0d1117; padding: 12px 10px; }
        .calibrate-section { margin-bottom: 24px; }
        .setting-card { background-color: #161b22; padding: 16px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #30363d; }
        .card-title { font-size: 18px; font-weight: bold; margin-bottom: 16px; color: #58a6ff; }
        label { display: block; margin-bottom: 18px; font-size: 14px; line-height: 1.4; }
        input[type="range"] { width: 100%; margin-top: 8px; -webkit-appearance: none; height: 8px; background: #30363d; border-radius: 4px; outline: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 22px; height: 22px; background: #58a6ff; border: 3px solid #0d1117; border-radius: 50%; cursor: pointer; }
        .current-value { font-weight: bold; color: #58a6ff; float: right; }
        .toggle-label { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; cursor: pointer; }
        input[type="checkbox"] { appearance: none; width: 20px; height: 20px; border: 2px solid #58a6ff; border-radius: 4px; background-color: #161b22; display: grid; place-content: center; cursor: pointer; transition: background-color 0.2s; }
        input[type="checkbox"]:checked { background-color: #58a6ff; border-color: #58a6ff; }
        input[type="checkbox"]::before { content: "‚úì"; font-size: 16px; color: #0d1117; opacity: 0; transition: opacity 0.1s; }
        input[type="checkbox"]:checked::before { opacity: 1; }
        .tips-section .card-title { color: #ffaa33; }
        .tips-list { list-style-type: 'üí° '; padding-left: 20px; margin-top: 8px; font-size: 14px; color: #8b949e; }
        .tips-list li { margin-bottom: 8px; }
        hr { border: none; border-top: 1px solid #30363d; margin: 15px 0; }
        
        #statusMessage {
            text-align: center;
            margin-top: -15px;
            margin-bottom: 15px;
            font-weight: bold;
            color: #ffaa33;
        }
    </style>
</head>
<body>

<div class="container">

  <div class="camera-feed">
    <video id="webcam" autoplay playsinline></video>
    <canvas id="outputCanvas"></canvas>
  </div>
  
  <div id="statusMessage">‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏î "‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</div>

  <div class="main-action-buttons">
    <button id="startBtn" class="btn">‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö</button>
    <button id="stopBtn" class="btn">‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î</button>
  </div>
  
  <div class="calibrate-section">
    <button id="calibrateBtn" class="btn">‚ú® ‡∏™‡∏≠‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö (‡∏ó‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏î‡∏µ)</button>
  </div>

  <hr>

  <div class="setting-card">
    <div class="card-title">‚è∞ ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á</div>

    <label>
      ‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (‡∏°‡∏¥‡∏•‡∏•‡∏¥‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ): 
      <span id="holdVal" class="current-value">2000 ‡∏°‡∏™.</span>
      <input id="holdTime" type="range" min="500" max="5000" step="100" value="2000">
    </label>

    <label>
      ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ): 
      <span id="cooldownVal" class="current-value">30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</span>
      <input id="cooldownRange" type="range" min="5" max="120" step="5" value="30">
    </label>

    <label>
      ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ü‡∏£‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏û‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö: 
      <span id="smoothVal" class="current-value">5 ‡πÄ‡∏ü‡∏£‡∏°</span>
      <input id="smoothRange" type="range" min="1" max="15" step="1" value="5">
    </label>
  </div>

  <div class="setting-card">
    <div class="card-title">üìê ‡∏°‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß)</div>

    <label>
      ‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏°‡∏∏‡∏°‡∏Ñ‡∏≠‡πÇ‡∏ô‡πâ‡∏°‡πÑ‡∏õ‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤ (‡∏≠‡∏á‡∏®‡∏≤): 
      <span id="neckThrVal" class="current-value">40¬∞</span>
      <input id="neckThr" type="range" min="20" max="80" step="1" value="40">
    </label>

    <label>
      ‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏°‡∏∏‡∏°‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡πà‡∏≠‡∏°/‡∏´‡∏•‡∏±‡∏á‡∏á‡∏≠ (‡∏≠‡∏á‡∏®‡∏≤): 
      <span id="backThrVal" class="current-value">20¬∞</span>
      <input id="backThr" type="range" min="5" max="60" step="1" value="20">
    </label>
  </div>
  
  <div class="setting-card">
    <div class="card-title">üì¢ ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</div>
    
    <label class="toggle-label">
      <input type="checkbox" id="audioToggle" checked> 
      ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
    </label>
    
    <label class="toggle-label">
      <input type="checkbox" id="vibrateToggle"> 
      ‡πÄ‡∏õ‡∏¥‡∏î‡∏™‡∏±‡πà‡∏ô (‡∏´‡∏≤‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö)
    </label>
  </div>

  <div class="setting-card tips-section">
    <div class="card-title">‚ÑπÔ∏è ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
    <ul class="tips-list">
      <li>**‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô:** ‡∏Å‡∏î **‡∏™‡∏≠‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö** ‡∏Ç‡∏ì‡∏∞‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ô‡∏±‡πà‡∏á‡πÉ‡∏ô‡∏ó‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏™‡∏°‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</li>
      <li>**‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥:** ‡∏õ‡∏£‡∏±‡∏ö **‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏°‡∏∏‡∏°** ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏Å‡∏±‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á ‡πÅ‡∏•‡∏∞‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</li>
    </ul>
  </div>

</div>

<script>
    // **********************************************
    // 2. JAVASCRIPT LOGIC (UI & TENSORFLOW.JS)
    // **********************************************

    const video = document.getElementById('webcam');
    const canvas = document.getElementById('outputCanvas');
    const ctx = canvas.getContext('2d');
    const statusMessage = document.getElementById('statusMessage');
    
    let model;
    let animationFrameId;
    let calibratedAngles = { neck: 0, back: 0 };
    let badPostureStartTime = null;
    let isMonitoring = false;
    let isCoolingDown = false;

    // **********************************************
    // A. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏°‡∏∏‡∏° (‡πÉ‡∏ä‡πâ keypoints ‡∏à‡∏≤‡∏Å MoveNet)
    // **********************************************

    /**
     * ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏°‡∏∏‡∏°‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 3 ‡∏à‡∏∏‡∏î (A, B, C) ‡πÇ‡∏î‡∏¢ B ‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏∏‡∏î‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á
     * @param {number[]} a - [y, x] ‡∏Ç‡∏≠‡∏á‡∏à‡∏∏‡∏î A
     * @param {number[]} b - [y, x] ‡∏Ç‡∏≠‡∏á‡∏à‡∏∏‡∏î B (Vertex)
     * @param {number[]} c - [y, x] ‡∏Ç‡∏≠‡∏á‡∏à‡∏∏‡∏î C
     * @returns {number} Angle in degrees.
     */
    function calculateAngle(a, b, c) {
        const rad = Math.atan2(c[0] - b[0], c[1] - b[1]) - Math.atan2(a[0] - b[0], a[1] - b[1]);
        let angle = Math.abs(rad * 180.0 / Math.PI);
        if (angle > 180.0) {
            angle = 360 - angle;
        }
        return angle;
    }

    /**
     * ‡∏î‡∏∂‡∏á‡∏°‡∏∏‡∏°‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏ó‡πà‡∏≤‡∏ó‡∏≤‡∏á
     * @param {object} keypoints - Keypoints object ‡∏à‡∏≤‡∏Å MoveNet
     * @returns {object} { neck: angle, back: angle }
     */
    function getPostureAngles(keypoints) {
        const points = keypoints.map(p => [p.y, p.x]); // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô [y, x]

        const leftShoulder = points[5];
        const rightShoulder = points[6];
        const leftHip = points[11];
        const rightHip = points[12];
        const nose = points[0];
        const ear = points[3]; // ‡πÉ‡∏ä‡πâ Left Ear ‡∏´‡∏£‡∏∑‡∏≠ Right Ear ‡∏Å‡πá‡πÑ‡∏î‡πâ

        // 1. ‡∏°‡∏∏‡∏°‡∏Ñ‡∏≠/‡∏´‡∏±‡∏ß (Neck Angle): ‡∏°‡∏∏‡∏°‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏π (Ear), ‡πÑ‡∏´‡∏•‡πà (Shoulder) ‡πÅ‡∏•‡∏∞‡∏à‡∏°‡∏π‡∏Å (Nose)
        // ‡πÉ‡∏ä‡πâ‡πÑ‡∏´‡∏•‡πà‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏∏‡∏î‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£)
        const centerShoulder = [(leftShoulder[0] + rightShoulder[0]) / 2, (leftShoulder[1] + rightShoulder[1]) / 2];
        const neckAngle = calculateAngle(nose, centerShoulder, ear);

        // 2. ‡∏°‡∏∏‡∏°‡∏´‡∏•‡∏±‡∏á (Back Angle): ‡∏°‡∏∏‡∏°‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏£‡∏á‡∏Ç‡∏≠‡∏á‡∏•‡∏≥‡∏ï‡∏±‡∏ß (‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏´‡∏•‡πà, ‡∏™‡∏∞‡πÇ‡∏û‡∏Å, ‡πÅ‡∏•‡∏∞‡πÄ‡∏Ç‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á)
        // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏á‡πà‡∏≤‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡πà‡∏á ‡πÉ‡∏ä‡πâ‡∏°‡∏∏‡∏°‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á ‡πÑ‡∏´‡∏•‡πà-‡∏™‡∏∞‡πÇ‡∏û‡∏Å-‡∏à‡∏∏‡∏î‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á
        const centerHip = [(leftHip[0] + rightHip[0]) / 2, (leftHip[1] + rightHip[1]) / 2];
        
        // ‡∏à‡∏∏‡∏î‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á: ‡πÉ‡∏ä‡πâ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ï‡πà‡∏≥‡∏•‡∏á‡∏°‡∏≤‡πÉ‡∏ô‡πÅ‡∏ô‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏™‡∏∞‡πÇ‡∏û‡∏Å (‡∏à‡∏≥‡∏•‡∏≠‡∏á‡πÄ‡∏Ç‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏∑‡πâ‡∏ô)
        const verticalReference = [centerHip[0] + 0.5, centerHip[1]]; // ‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏ï‡πà‡∏≥‡∏•‡∏á‡πÑ‡∏õ

        // ‡∏°‡∏∏‡∏°‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á ‡πÑ‡∏´‡∏•‡πà-‡∏™‡∏∞‡πÇ‡∏û‡∏Å-‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á (‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡∏•‡∏≥‡∏ï‡∏±‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡πÑ‡∏õ‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏°‡∏≤‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÅ‡∏Ñ‡πà‡πÑ‡∏´‡∏ô)
        const backAngle = calculateAngle(centerShoulder, centerHip, verticalReference);


        // ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏á‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡∏°‡∏∏‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πà‡∏á/‡∏Ñ‡∏≠
        // (‡πÉ‡∏ô‡∏ó‡∏≤‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥ ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏à‡∏∏‡∏î Keypoints ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡∏°‡∏∏‡∏°‡∏ó‡∏µ‡πà‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î)
        return { neck: neckAngle, back: backAngle };
    }

    // **********************************************
    // B. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö TensorFlow.js
    // **********************************************

    async function loadModel() {
        statusMessage.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•...';
        model = await movenet.load(2, { minPoseScore: 0.1 });
        statusMessage.textContent = '‚úÖ ‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏î "‡∏™‡∏≠‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô';
    }

    async function setupCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 'video': true });
            video.srcObject = stream;
            return new Promise((resolve) => {
                video.onloadedmetadata = () => {
                    resolve(video);
                };
            });
        } catch (error) {
            statusMessage.textContent = '‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ: ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå';
            console.error('Error accessing webcam:', error);
            return null;
        }
    }

    function drawKeypoints(keypoints) {
        // ‡∏ß‡∏≤‡∏î‡∏à‡∏∏‡∏î‡πÅ‡∏•‡∏∞‡πÄ‡∏™‡πâ‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ (Skeleton)
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // ‡∏ß‡∏≤‡∏î‡∏à‡∏∏‡∏î
        keypoints.forEach(point => {
            if (point.score > 0.3) { // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏±‡πà‡∏ô‡∏™‡∏π‡∏á
                ctx.beginPath();
                ctx.arc(point.x * canvas.width / video.videoWidth, point.y * canvas.height / video.videoHeight, 5, 0, 2 * Math.PI);
                ctx.fillStyle = '#03DAC6'; // ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
                ctx.fill();
            }
        });
        
        // ‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô (‡∏•‡∏∞‡πÄ‡∏ß‡πâ‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏á‡πà‡∏≤‡∏¢‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ ‡πÅ‡∏ï‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ)
    }

    async function poseDetectionFrame() {
        if (!isMonitoring || !model) {
            return;
        }

        const videoWidth = video.videoWidth;
        const videoHeight = video.videoHeight;
        canvas.width = videoWidth;
        canvas.height = videoHeight;
        
        // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏ó‡πà‡∏≤‡∏ó‡∏≤‡∏á
        const pose = await model.estimatePoses(video, { maxPoses: 1, flipHorizontal: false });

        if (pose.length > 0) {
            const keypoints = pose[0].keypoints.slice(0, 13); // ‡πÉ‡∏ä‡πâ‡πÅ‡∏Ñ‡πà 13 ‡∏à‡∏∏‡∏î‡∏´‡∏•‡∏±‡∏Å
            drawKeypoints(keypoints);
            
            // 2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡πà‡∏≤‡∏ó‡∏≤‡∏á
            checkPosture(keypoints);
        }

        animationFrameId = requestAnimationFrame(poseDetectionFrame);
    }

    function checkPosture(keypoints) {
        if (Object.values(calibratedAngles).every(a => a === 0)) {
            statusMessage.textContent = '‚ö†Ô∏è ‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏î "‡∏™‡∏≠‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö" ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö';
            return;
        }

        const currentAngles = getPostureAngles(keypoints);
        const neckThr = parseFloat(document.getElementById('neckThr').value);
        const backThr = parseFloat(document.getElementById('backThr').value);

        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏ó‡πà‡∏≤‡∏™‡∏≠‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö
        const neckDiff = Math.abs(currentAngles.neck - calibratedAngles.neck);
        const backDiff = Math.abs(currentAngles.back - calibratedAngles.back);

        let isBadPosture = false;

        if (neckDiff > neckThr) {
            isBadPosture = true;
            statusMessage.textContent = `‚ùå ‡∏ó‡πà‡∏≤‡∏ó‡∏≤‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: ‡∏Ñ‡∏≠‡πÇ‡∏ô‡πâ‡∏° (${neckDiff.toFixed(1)}¬∞ > ${neckThr}¬∞)`
        } else if (backDiff > backThr) {
            isBadPosture = true;
            statusMessage.textContent = `‚ùå ‡∏ó‡πà‡∏≤‡∏ó‡∏≤‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: ‡∏´‡∏•‡∏±‡∏á‡∏á‡∏≠ (${backDiff.toFixed(1)}¬∞ > ${backThr}¬∞)`
        } else {
            statusMessage.textContent = '‚úÖ ‡∏ó‡πà‡∏≤‡∏ó‡∏≤‡∏á‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
            badPostureStartTime = null; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏ö
        }

        // 3. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
        if (isBadPosture && !isCoolingDown) {
            if (badPostureStartTime === null) {
                badPostureStartTime = Date.now();
            }
            
            const holdTime = parseFloat(document.getElementById('holdTime').value);

            if (Date.now() - badPostureStartTime >= holdTime) {
                triggerAlert();
                badPostureStartTime = null; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏´‡∏•‡∏±‡∏á Alert
            }
        }
    }

    function triggerAlert() {
        const cooldownTime = parseFloat(document.getElementById('cooldownRange').value);
        const audioToggle = document.getElementById('audioToggle').checked;
        const vibrateToggle = document.getElementById('vibrateToggle').checked;

        // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
        statusMessage.textContent = 'üö® ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô! ‡∏õ‡∏£‡∏±‡∏ö‡∏ó‡πà‡∏≤‡∏ó‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì';
        if (audioToggle) {
            const audio = new Audio('https://www.soundjay.com/buttons/beep-01a.mp3'); // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á
            audio.play();
        }
        if (vibrateToggle && navigator.vibrate) {
            navigator.vibrate(500);
        }
        
        // ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏ä‡πà‡∏ß‡∏á Cooldown
        isCoolingDown = true;
        setTimeout(() => {
            isCoolingDown = false;
            statusMessage.textContent = '‚úÖ ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏ä‡πà‡∏ß‡∏á‡∏û‡∏±‡∏Å, ‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö';
        }, cooldownTime * 1000); 
    }

    // **********************************************
    // C. ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ UI ‡πÅ‡∏•‡∏∞ Event Listeners
    // **********************************************

    document.getElementById('startBtn').addEventListener('click', async () => {
        if (isMonitoring) return;
        
        isMonitoring = true;
        const videoElement = await setupCamera();
        if (videoElement) {
            videoElement.play();
            statusMessage.textContent = '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö...';
            poseDetectionFrame();
        }
    });

    document.getElementById('stopBtn').addEventListener('click', () => {
        isMonitoring = false;
        if (animationFrameId) {
            cancelAnimationFrame(animationFrameId);
        }
        const stream = video.srcObject;
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
        }
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        statusMessage.textContent = '‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö';
    });

    document.getElementById('calibrateBtn').addEventListener('click', async () => {
        if (!isMonitoring) {
            alert('‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏î "‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö" ‡πÅ‡∏•‡∏∞‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö');
            return;
        }

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏ó‡πà‡∏≤‡∏ó‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏≠‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö
        const pose = await model.estimatePoses(video, { maxPoses: 1, flipHorizontal: false });

        if (pose.length > 0) {
            const keypoints = pose[0].keypoints.slice(0, 13);
            calibratedAngles = getPostureAngles(keypoints);
            
            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏°‡∏∏‡∏°‡∏´‡∏•‡∏±‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô 0 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Angle Diff ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏ó‡πà‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏ï‡∏£‡∏á
            // (‡πÉ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏£‡∏¥‡∏á ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà‡∏î‡∏µ)
            alert(`‚ú® ‡∏™‡∏≠‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡πà‡∏≤‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏î‡∏µ‡πÅ‡∏•‡πâ‡∏ß (‡∏Ñ‡∏≠: ${calibratedAngles.neck.toFixed(1)}¬∞, ‡∏´‡∏•‡∏±‡∏á: ${calibratedAngles.back.toFixed(1)}¬∞)`);
            statusMessage.textContent = '‚úÖ ‡∏™‡∏≠‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏ó‡πà‡∏≤‡∏ó‡∏≤‡∏á';
        } else {
            alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ï‡∏±‡∏ß‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡πÉ‡∏ô‡∏Å‡∏•‡πâ‡∏≠‡∏á! ‡πÇ‡∏õ‡∏£‡∏î‡∏ô‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏ï‡πá‡∏°‡∏ï‡∏±‡∏ß');
            statusMessage.textContent = '‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ï‡∏±‡∏ß‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•';
        }
    });

    // JavaScript ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô (‡πÄ‡∏î‡∏¥‡∏°)
    const controls = [
        { range: 'cooldownRange', value: 'cooldownVal', suffix: ' ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ', initial: 30 },
        { range: 'smoothRange', value: 'smoothVal', suffix: ' ‡πÄ‡∏ü‡∏£‡∏°', initial: 5 },
        { range: 'neckThr', value: 'neckThrVal', suffix: '¬∞', initial: 40 },
        { range: 'backThr', value: 'backThrVal', suffix: '¬∞', initial: 20 },
        { range: 'holdTime', value: 'holdVal', suffix: ' ‡∏°‡∏™.', initial: 2000 }
    ];

    controls.forEach(control => {
        const range = document.getElementById(control.range);
        const valueSpan = document.getElementById(control.value);
        if (range && valueSpan) {
            range.value = control.initial; 
            valueSpan.textContent = range.value + control.suffix;
            range.addEventListener('input', (e) => {
                valueSpan.textContent = e.target.value + control.suffix;
            });
        }
    });

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
    window.onload = loadModel;
</script>
</body>
</html>
